services:
  # Kafka broker (KRaft mode, no ZooKeeper)
  kafka:
    image: apache/kafka:3.7.0
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9094,INTERNAL://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,INTERNAL://kafka:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,INTERNAL:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9094
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      CLUSTER_ID: "RWdnRWNvbm9teUtzUWxEQg"
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # ksqlDB server
  ksqldb-server:
    image: confluentinc/ksqldb-server:0.29.0
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8088:8088"
    environment:
      KSQL_BOOTSTRAP_SERVERS: kafka:9093
      KSQL_LISTENERS: http://0.0.0.0:8088
      KSQL_KSQL_SERVICE_ID: egg-economy-ksqldb
      KSQL_KSQL_STREAMS_CACHE_MAX_BYTES_BUFFERING: 0
      KSQL_KSQL_STREAMS_AUTO_OFFSET_RESET: earliest
      KSQL_KSQL_QUERY_PULL_TABLE_SCAN_ENABLED: "true"
      KSQL_KSQL_STREAMS_COMMIT_INTERVAL_MS: 100
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8088/info || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s

  # Egg Economy ksqlDB MeshQL application
  egg-economy-ksqldb:
    build:
      context: ../..
      dockerfile: examples/egg-economy-ksqldb/Dockerfile
    depends_on:
      kafka:
        condition: service_healthy
      ksqldb-server:
        condition: service_healthy
    ports:
      - "5090:5090"
    environment:
      - PORT=5090
      - BOOTSTRAP_SERVERS=kafka:9093
      - KSQL_DB_URL=http://ksqldb-server:8088
      - PREFIX=eggs
      - ENV=development
      - PLATFORM_URL=http://egg-economy-ksqldb:5090
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5090/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Frontend: Homesteader PWA (reused from egg-economy)
  homesteader-app:
    build:
      context: ../egg-economy/homesteader-app
    depends_on:
      egg-economy-ksqldb:
        condition: service_healthy

  # Frontend: Corporate Portal (reused from egg-economy)
  corporate-app:
    build:
      context: ../egg-economy/corporate-app
    depends_on:
      egg-economy-ksqldb:
        condition: service_healthy

  # Frontend: National Dashboard (reused from egg-economy)
  dashboard-app:
    build:
      context: ../egg-economy/dashboard-app
    depends_on:
      egg-economy-ksqldb:
        condition: service_healthy

  # Nginx reverse proxy
  nginx:
    image: nginx:alpine
    ports:
      - "8090:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - homesteader-app
      - corporate-app
      - dashboard-app
      - egg-economy-ksqldb

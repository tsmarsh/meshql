<!DOCTYPE html>
<html lang="en" data-theme="emerald">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Egg Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script type="module" src="js/app.js"></script>
</head>
<body class="bg-base-200 min-h-screen" x-data="dashboard">

    <!-- Navbar -->
    <div class="navbar shadow-lg bg-primary text-primary-content">
        <div class="flex-1">
            <span class="text-xl font-bold px-4">Enterprise Egg Analytics</span>
            <span class="badge badge-ghost">Data Lake</span>
        </div>
        <div class="flex-none px-4 text-sm opacity-75">
            Powered by DuckDB + MinIO
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4">

        <template x-if="error">
            <div class="alert alert-error mb-4"><span x-text="error"></span></div>
        </template>

        <template x-if="loading">
            <div class="flex justify-center py-20"><span class="loading loading-spinner loading-lg"></span></div>
        </template>

        <div x-show="!loading" x-cloak>

            <!-- Summary Cards -->
            <h2 class="text-lg font-semibold mb-3 mt-2">Cross-System Summary</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="stat bg-base-100 rounded-box shadow">
                    <div class="stat-title">Farms (SAP)</div>
                    <div class="stat-value text-primary" x-text="summary.total_farms || 0"></div>
                </div>
                <div class="stat bg-base-100 rounded-box shadow">
                    <div class="stat-title">Eggs Produced</div>
                    <div class="stat-value text-secondary" x-text="(summary.eggs_produced || 0).toLocaleString()"></div>
                </div>
                <div class="stat bg-base-100 rounded-box shadow">
                    <div class="stat-title">Eggs Consumed</div>
                    <div class="stat-value text-accent" x-text="(summary.eggs_consumed || 0).toLocaleString()"></div>
                </div>
                <div class="stat bg-base-100 rounded-box shadow">
                    <div class="stat-title">Containers (Distro)</div>
                    <div class="stat-value" x-text="summary.total_containers || 0"></div>
                </div>
                <div class="stat bg-base-100 rounded-box shadow">
                    <div class="stat-title">Consumers (Distro)</div>
                    <div class="stat-value" x-text="summary.total_consumers || 0"></div>
                </div>
            </div>

            <!-- Production Charts -->
            <h2 class="text-lg font-semibold mb-3">Farm Production (from Lake)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="card bg-base-100 shadow">
                    <div class="card-body">
                        <h3 class="card-title text-sm">Total Eggs by Farm</h3>
                        <canvas id="farmOutputChart"></canvas>
                    </div>
                </div>
                <div class="card bg-base-100 shadow">
                    <div class="card-body">
                        <h3 class="card-title text-sm">Avg Eggs per Report by Farm</h3>
                        <canvas id="farmAvgChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Farm Output Table -->
            <div class="card bg-base-100 shadow mb-6">
                <div class="card-body">
                    <h3 class="card-title text-sm">Farm Output Details</h3>
                    <div class="overflow-x-auto">
                        <table class="table table-xs">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Farm ID</th>
                                    <th>Reports</th>
                                    <th>Total Eggs</th>
                                    <th>Avg Eggs/Report</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(f, i) in farmOutputs" :key="f.farm_id">
                                    <tr>
                                        <td x-text="i + 1"></td>
                                        <td class="text-xs font-mono" x-text="(f.farm_id || '').substring(0, 8) + '...'"></td>
                                        <td x-text="f.report_count || 0"></td>
                                        <td class="font-medium" x-text="(f.total_eggs || 0).toLocaleString()"></td>
                                        <td x-text="(f.avg_eggs_per_report || 0).toFixed(1)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Hen Productivity -->
            <h2 class="text-lg font-semibold mb-3">Hen Productivity (from Lake)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="card bg-base-100 shadow">
                    <div class="card-body">
                        <h3 class="card-title text-sm">Top Hens by Total Eggs</h3>
                        <canvas id="henProductivityChart"></canvas>
                    </div>
                </div>
                <div class="card bg-base-100 shadow">
                    <div class="card-body">
                        <h3 class="card-title text-sm">Quality Rate by Hen</h3>
                        <canvas id="henQualityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Hen Productivity Table -->
            <div class="card bg-base-100 shadow mb-6">
                <div class="card-body">
                    <h3 class="card-title text-sm">Hen Productivity Details</h3>
                    <div class="overflow-x-auto">
                        <table class="table table-xs">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Hen ID</th>
                                    <th>Farm ID</th>
                                    <th>Reports</th>
                                    <th>Total Eggs</th>
                                    <th>Avg/Report</th>
                                    <th>Quality Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(h, i) in henProductivities.slice(0, 15)" :key="h.hen_id">
                                    <tr>
                                        <td x-text="i + 1"></td>
                                        <td class="text-xs font-mono" x-text="(h.hen_id || '').substring(0, 8) + '...'"></td>
                                        <td class="text-xs font-mono" x-text="(h.farm_id || '').substring(0, 8) + '...'"></td>
                                        <td x-text="h.report_count || 0"></td>
                                        <td class="font-medium" x-text="(h.total_eggs || 0).toLocaleString()"></td>
                                        <td x-text="(h.avg_eggs_per_report || 0).toFixed(1)"></td>
                                        <td x-text="h.quality_rate != null ? (h.quality_rate * 100).toFixed(0) + '%' : '--'"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Container Inventory -->
            <h2 class="text-lg font-semibold mb-3">Container Inventory (from Lake)</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="stat bg-base-100 rounded-box shadow">
                    <div class="stat-title">Total in Storage</div>
                    <div class="stat-value text-primary" x-text="totalInStorage.toLocaleString()"></div>
                </div>
                <div class="stat bg-base-100 rounded-box shadow">
                    <div class="stat-title">Total Deposited</div>
                    <div class="stat-value text-secondary" x-text="totalDeposited.toLocaleString()"></div>
                </div>
                <div class="stat bg-base-100 rounded-box shadow">
                    <div class="stat-title">Total Consumed</div>
                    <div class="stat-value text-accent" x-text="totalConsumed.toLocaleString()"></div>
                </div>
            </div>
            <div class="card bg-base-100 shadow mb-6">
                <div class="card-body">
                    <h3 class="card-title text-sm">Current Eggs by Container</h3>
                    <canvas id="inventoryChart"></canvas>
                </div>
            </div>

            <!-- Container Inventory Table -->
            <div class="card bg-base-100 shadow mb-6">
                <div class="card-body">
                    <h3 class="card-title text-sm">Container Inventory Details</h3>
                    <div class="overflow-x-auto">
                        <table class="table table-xs">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Container ID</th>
                                    <th>Deposits</th>
                                    <th>Withdrawals</th>
                                    <th>Transfers In</th>
                                    <th>Transfers Out</th>
                                    <th>Consumed</th>
                                    <th>Current Eggs</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(ci, i) in containerInventories" :key="ci.container_id">
                                    <tr>
                                        <td x-text="i + 1"></td>
                                        <td class="text-xs font-mono" x-text="(ci.container_id || '').substring(0, 8) + '...'"></td>
                                        <td x-text="ci.total_deposits || 0"></td>
                                        <td x-text="ci.total_withdrawals || 0"></td>
                                        <td x-text="ci.total_transfers_in || 0"></td>
                                        <td x-text="ci.total_transfers_out || 0"></td>
                                        <td x-text="ci.total_consumed || 0"></td>
                                        <td class="font-medium" x-text="(ci.current_eggs || 0).toLocaleString()"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="footer footer-center p-4 text-base-content mt-8">
        <p>Powered by <a href="https://github.com/tsmarsh/meshql" class="link link-primary" target="_blank">MeshQL</a> + DuckDB Data Lake</p>
    </footer>

</body>
</html>
